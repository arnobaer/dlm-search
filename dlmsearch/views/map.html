{% extends "leaflet.html" %}

{% block styles %}
 <style>
  #map {
    width: 100%;
    height: 480px;
  }
 </style>
{% endblock %}

{% block content %}
  <div class="w3-container">
    <h3>{{Â title }}</h3>
  </div>
  <div class="w3-container w3-panel">
    <form>
      <input type="text" name="q" value="{{ q }}">
      <select name="category">
        <option value="">Any</option>
{% for index, name in categories.items() %}
        <option value="{{ index }}"{% if category == index %} selected{% endif%}>{{ name }}</option>
{% endfor %}
      </select>
      <input type="submit" value="Search">
{% if locations %}
      <span>Found {{ locations|count }} locations.</span>
{% elif q %}
      <span>Nothing found.</span>
{% endif %}
    </form>
  </div>
  <div class="w3-container">
    <div id="map"></div>
  </div>
  <div class="w3-container">
    <table  class="w3-table">
{% if locations %}
      <tr>
        <th>Name</th>
        <th>Category</th>
        <th>lat</th>
        <th>lon</th>
      </tr>
{% endif %}
{% for location in locations %}
      <tr>
        <td>{{ location.name|escape }}{% if location.var_name %} ({{ location.var_name|escape }}){% endif %}</td>
        <td>{{ get_category(location.category) }}</td>
        <td>{{ '%.4f' % location.lat }}</td>
        <td>{{ '%.4f' % location.lon }}</td>
      </tr>
{% endfor %}
    </table>
  </div>
  <div class="w3-container">
  </div>
{% endblock %}

{% block scripts %}
{{ super() }}
  <script>
    (function() {
      var bounds = new L.LatLngBounds([{% for location in locations %}[{{ location.lat }}, {{ location.lon }}],{% endfor %}]);
      var map = L.map('map', {
        scrollWheelZoom: false
        }).setView([47.333, 13.333], 7);
      if (bounds.length) {
        map.fitBounds(bounds, {padding: [50, 50]});
      }
      L.tileLayer('https://{s}.wien.gv.at/basemap/geolandbasemap/normal/google3857/{z}/{y}/{x}.png', {
        minZoom: 1,
        maxZoom: 18,
        attribution: '<a href="https://basemap.at" target="_blank">basemap.at</a>, <a href="https://creativecommons.org/licenses/by/3.0/at/deed.de" target="_blank">CC-BY 3.0</a> | <a href="https://bev.gv.at" target="_blank">bev.gv.at</a>, <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC-BY 4.0</a>',
        tms: false,
        subdomains: ["maps", "maps1", "maps2", "maps3"],
      }).addTo(map);
      var markers = L.markerClusterGroup();
{% for location in locations %}
      L.marker([{{ location.lat }}, {{ location.lon }}]).bindPopup(
        `<div>{{ location.name|escape }}{% if location.var_name %} ({{ location.var_name|escape }}){% endif %}</div>
         <div>Category: {{ get_category(location.category) }}</div>
         <div><span title="Latitude">{{ '%.4f' % location.lat }}</span>, <span title="Longitude">{{ '%.4f' % location.lon }}</span></div>`).on('mouseover', function (e) {
        this.openPopup();
      }).on('mouseout', function (e) {
        this.closePopup();
      }).on('click', function (e) {}).addTo(markers);
{% endfor %}
      map.addLayer(markers);
    })();
  </script>
{% endblock %}
